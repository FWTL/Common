version: '{build}'

branches:
  only:
  - master

init:
    - ps: |
            Set-AppveyorBuildVariable -Name "BuildCore" -Value True
            Set-AppveyorBuildVariable -Name "BuildInfrastructure" -Value True

            If ($Env:APPVEYOR_REPO_TAG_NAME -match "Infrastructure"){
              Set-AppveyorBuildVariable -Name "BuildInfrastructure" -Value True
            }
            If ($Env:APPVEYOR_REPO_TAG_NAME -match "Core"){
              Set-AppveyorBuildVariable -Name "BuildCore" -Value True
            }
            If ($Env:APPVEYOR_REPO_TAG_NAME -match "All"){
              Set-AppveyorBuildVariable -Name "BuildCore" -Value True
              Set-AppveyorBuildVariable -Name "BuildInfrastructure" -Value True
            }

    - cmd: git config --global core.autocrlf true

artifacts:
  - path: FWTL.Core\nupkgs\*.nupkg
    name: nuget-core
  - path: FWTL.Infrastructure\nupkgs\*.nupkg
    name: nuget-infrastructure

cache:
  - packages -> FWTL.Core.csproj, FWTL.Infrastructure.csproj

pull_requests:
  do_not_increment_build_number: true

before_build:
  - cmd: dotnet restore FWTL.sln

build_script:
  - cmd: dotnet build FWTL.sln --no-restore 

after_build:
- ps: >-
    if($(BuildCore))
    {
        dotnet pack FWTL.Core/FWTL.Core.csproj --no-build --output nupkgs -p:PackageVersion= $env:APPVEYOR_REPO_TAG_NAME
    }

    if($(BuildInfrastructure))
    {
        dotnet pack FWTL.Infrastructure/FWTL.Infrastructure.csproj --no-build --output nupkgs -p:PackageVersion= $env:APPVEYOR_REPO_TAG_NAME
    }

nuget:
    disable_publish_on_pr: true
    
deploy: 
    - provider: NuGet
      api_key:
          secure: 55pO38HXY6SYCcSyEDy6XVdpDgJOasIlIp/MIOlwZoH+rEj4fN+hMabmP+0wJyt5
      artifact: nuget-core
      on:
          appveyor_repo_tag_name: /\d+\.\d+\.\d+(-{0,1})(alpha|$)/
          appveyor_repo_tag: true
    - provider: NuGet
      api_key:
          secure: 55pO38HXY6SYCcSyEDy6XVdpDgJOasIlIp/MIOlwZoH+rEj4fN+hMabmP+0wJyt5
      artifact: nuget-infrastructure
      on:
          appveyor_repo_tag_name: /\d+\.\d+\.\d+(-{0,1})(alpha|$)/
          appveyor_repo_tag: true
  
  
notifications:
- provider: Email
  to:
  - golaszewski.a@gmail.info
  on_build_success: false
  on_build_failure: true
  on_build_status_changed: false